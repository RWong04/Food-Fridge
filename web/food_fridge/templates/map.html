{% load static %}
<!DOCTYPE html>
<html lang="zh-Hant">

   <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="{% static 'src/style.css' %}">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
           integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
   </head>

   <body>
        <form class="flex items-center max-w-sm mx-auto" id="search-food-form" action="/api/search/" method="GET">   
            <div class="relative w-full">
                <input type="text" id="simple-search" name="simple-search" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full ps-10 p-2.5  dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="搜尋剩食" required />
            </div>
            <button type="submit" class="p-2.5 ms-2 text-sm font-medium text-white bg-red-300 rounded-lg border bg-red-300 hover:bg-red-400 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:bg-red-200 dark:hover:bg-red-400 dark:focus:ring-blue-800">
                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
                </svg>
                <span class="sr-only">Search</span>
            </button>
            
        </form>

        <div id="info-window" class="info-window" >
            <button class="close-btn" onclick="closeInfoWindow()">×</button>
            <div class="scroll-window"></div>
            
        </div>

        <div class="detail-window">
            <button class="close-btn" onclick="closeDetailWindow()">×</button>
            
        </div>

       <div id="map"></div>
       </div>
       <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
           integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="">
        </script>

        <script>
            const searchForm = document.getElementById('search-food-form');
            const searchInput = document.getElementById('simple-search');
            const infoWindow = document.getElementById("info-window");
            const scrollWindow = document.querySelector(".scroll-window");
    
            //  add event listener to the form
            searchForm.addEventListener('submit', function(event) {
                event.preventDefault();
    
                const searchTerm = searchInput.value;  // get keyword from input
                //alert(`Searching for: ${searchTerm}`);
    
                fetch(`/api/search/?simple-search=${encodeURIComponent(searchTerm)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        //  show info window
                        displaySearchResults(data);
                    })
                    .catch(error => {
                        console.error('There was a problem with the fetch operation:', error);
                        alert('Failed to retrieve search results.');
                    });
            });
    
            function displaySearchResults(results) {
                // show the info window
                infoWindow.style.display = "block";
                //  clear previous results
                while (scrollWindow.firstChild) {
                    scrollWindow.removeChild(scrollWindow.firstChild);
                }
    
                var cardCount = results.length;
                var infoHeader = document.createElement("div");
                infoHeader.classList.add("info-header");
                scrollWindow.appendChild(infoHeader);
                infoHeader.textContent = `${cardCount} 則搜尋結果`;
    
                results.forEach(item => {
                    var card = document.createElement("div");
                    card.classList.add("info-content");
                    card.innerHTML = `
                        <div class="max-w-sm p-6 bg-white border border-gray-200 rounded-xl shadow-sm dark:bg-gray-800 dark:border-gray-700">
                            <h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white">${item.name}</h5>
                            <p class="text-base text-gray-900 dark:text-gray-400">${item.description}</p>
                            <p class="text-sm text-gray-700 dark:text-gray-400">價格: $${item.price}</p>
                            <p class="text-sm text-gray-700 dark:text-gray-400">有效日期: ${new Date(item.expiration).toLocaleDateString()}</p>
                            <p class="text-sm text-gray-700 dark:text-gray-400">地址: ${item.food_address}</p>
                            <div style="display: flex; justify-content: flex-end;">
                                <button onclick="showDetailInfo(${item.id})" class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white bg-red-300 rounded-lg hover:bg-red-300 focus:ring-4 focus:outline-none focus:bg-red-300 dark:bg-red-300 dark:hover:bg-red-300 dark:focus:bg-red-300">
                                    查看詳情
                                </button>
                            </div>
                        </div>
                    `;
                    card.querySelector('.max-w-sm').style.width = '350px'; // Set desired width
                    scrollWindow.appendChild(card);
                });
                infoWindow.style.display = "block";
            }

        // To initialize the map--------------------------------------------------------------//
           var map = L.map('map', {zoomControl: false}).setView([23.773, 120.959], 8);

           L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
               attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
           }).addTo(map);

           var redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

           // get user's location
           map.locate({
               setView: true,
               maxZoom: 512
           });

           function onLocationFound(e) {

               L.marker(e.latlng).addTo(map)
                   .openPopup();

               L.circle(e.latlng, e.accuracy).addTo(map);
           }
           map.on('locationfound', onLocationFound);

           function onLocationError(e) {
               alert("找不到您的位置！");
           }
           map.on('locationerror', onLocationError);

        //--------------------------------------------------------------To initialize the map//
        
        // Set every window that will show on this page---------------------------------------------------//
        // 關閉搜尋列表
        function closeInfoWindow() {
            var infoWindow = document.getElementById("info-window");
            if (infoWindow.style.display === "block") {
                infoWindow.style.display = "none";
                var scrollWindow = document.querySelector(".scroll-window");
                
            }
        }

        // 關閉詳細資料視窗
        function closeDetailWindow() {
            var detailWindow = document.querySelector('.detail-window');
            var List = document.getElementById('info-window');
            if (detailWindow.style.display === "block") {
                detailWindow.style.display = "none";
                List.style.display = "block";
            }
        }
        
        
        let foodMarker = null; // Initialize foodMarker variable
        // 開啟詳細資料視窗
        function showDetailInfo(foodId) {
            var infoWindow = document.getElementById("info-window");
            var detailWindow = document.querySelector('.detail-window');
            //  var food = result.find(item => item[0] === foodId);  //以前的寫法
            var food = result.find(item => item.id === foodId);  //修改後的寫法
            // const [id, name, category, description, quantity, unit, price, expirationDate, latitude, longitude, isSoldOut] = food; // 以前的寫法

            if (infoWindow.style.display === "block") {
                infoWindow.style.display = "none";
                detailWindow.style.display = "block";
            } else {
                infoWindow.style.display = "block";
                detailWindow.style.display = "none";
            }

            detailWindow.innerHTML = '';
            detailWindow.innerHTML = `
                <div class="max-w-sm p-6 bg-white border border-gray-200 rounded-xl shadow-sm dark:bg-gray-800 dark:border-gray-700">
                    <h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white">${food.name}</h5>
                    <p class="text-base text-gray-900 dark:text-gray-400">${food.description}</p>
                    <p class="text-sm text-gray-700 dark:text-gray-400">數量: ${food.quantity} ${food.unit}</p>
                    <p class="text-sm text-gray-700 dark:text-gray-400">價格: $${food.price}</p>
                    <p class="text-sm text-gray-700 dark:text-gray-400">有效日期: ${new Date(food.expiration).toLocaleDateString()}</p>
                    <p class="text-sm text-gray-700 dark:text-gray-400">地址: ${food.food_address}</p>
                    <button class="close-btn" onclick="closeDetailWindow()">×</button>
                    <div style="display: flex; justify-content: center; margin-top: 20px;">
                        <button id="contactBtn" class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white bg-red-300 rounded-lg hover:bg-red-300 focus:ring-4 focus:outline-none focus:bg-red-300 dark:bg-red-300 dark:hover:bg-red-300 dark:focus:bg-red-300">
                            聯絡賣家
                        </button>
                    </div>
                </div>
            `;
            updateMapMarker(food.latitude, food.longitude); // Update the map marker with the new coordinates

        }

        //詳細資料的位置
        function updateMapMarker(latitude, longitude) {
            if (foodMarker !== null) {
                map.removeLayer(foodMarker); // Remove the old marker
            }

            if (latitude && longitude) {
                let newLatLng = new L.LatLng(latitude, longitude);
                map.setView(newLatLng, 512); // Center the map on the new location, you can adjust zoom level
                foodMarker = L.marker(newLatLng, { icon: redIcon }).addTo(map); // Add a new marker
            } else {
                console.warn("Latitude or longitude is not available.");
            }
        }
        // ---------------------------------------------------Set every window that will show on this page//
        
    </script>

    
   </body>

   </html>